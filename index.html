<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<title>rCount Dashboard</title>
<style>
  body {
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 50px;
  }
  button {
    padding: 10px 20px;
    font-size: 1.2rem;
    cursor: pointer;
  }
  #status, #timing {
    margin-top: 20px;
    font-size: 1rem;
    color: green;
    white-space: pre-line;
  }
</style>
</head>
<body>
<h1>rCount Dashboard</h1>
<button id="btnAdd">Add visit</button>
<div id="status"></div>
<div id="timing"></div>

<script>
const API_BASE = "https://rcount.onrender.com";

// Timing UI update
function updateTiming(msg) {
  const div = document.getElementById('timing');
  div.textContent += msg + "\n";
}

// Service Worker registreren met timing
if ('serviceWorker' in navigator) {
  const swStart = performance.now();
  navigator.serviceWorker.register('./sw.js')
    .then(reg => {
      const swRegistered = performance.now();
      updateTiming(`Service Worker registratie duurde ${(swRegistered - swStart).toFixed(2)} ms`);

      // Wachten tot SW klaar is
      navigator.serviceWorker.ready.then(() => {
        const swReady = performance.now();
        updateTiming(`Service Worker is actief en klaar in ${(swReady - swStart).toFixed(2)} ms`);
      });
    })
    .catch(e => {
      console.error("SW registratie mislukt:", e);
      updateTiming("SW registratie mislukt: " + e);
    });
}

// Functie om request te versturen via beacon en SW met timing
function addVisit() {
  const url = API_BASE + '/add';
  const payload = JSON.stringify({ time: Date.now() });
  const requestStart = performance.now();

  if (navigator.sendBeacon) {
    const blob = new Blob([payload], { type: 'text/plain' });
    const sent = navigator.sendBeacon(url, blob);
    const requestEnd = performance.now();

    if (sent) {
      document.getElementById('status').textContent = "Beacon succesvol verzonden!";
      updateTiming(`Beacon request duurde ${(requestEnd - requestStart).toFixed(2)} ms`);
      return;
    }
  }

  // Fallback naar SW retry
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'storeFailed',
      request: { url, body: payload }
    });
    const requestEnd = performance.now();
    document.getElementById('status').textContent = "Verzoek opgeslagen voor retry via SW";
    updateTiming(`SW fallback request duurde ${(requestEnd - requestStart).toFixed(2)} ms`);
  } else {
    const requestEnd = performance.now();
    document.getElementById('status').textContent = "Geen SW actief, probeer opnieuw!";
    updateTiming(`Request mislukte, duurde ${(requestEnd - requestStart).toFixed(2)} ms`);
  }
}

document.getElementById('btnAdd').addEventListener('click', addVisit);
</script>
</body>
</html>
