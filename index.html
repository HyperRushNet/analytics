<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<title>rCount Dashboard</title>
</head>
<body>
<button id="btnAdd">Add visit</button>

<script>
const API_BASE = "https://rcount.onrender.com";

// Service Worker registreren
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/analytics/sw.js').then(() => {
    console.log('SW registered');
  });
}

// Functie om request te versturen via beacon en SW
function addVisit() {
  const url = API_BASE + '/add';
  const payload = JSON.stringify({ time: Date.now() });

  // 1️⃣ Beacon sturen
  if (navigator.sendBeacon) {
    const blob = new Blob([payload], { type: 'application/json' });
    const sent = navigator.sendBeacon(url, blob);
    if (sent) {
      console.log('Beacon sent successfully');
      return;
    }
  }

  // 2️⃣ Als beacon faalt, message naar SW sturen voor retry
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'storeFailed',
      request: { url, body: payload }
    });
  } else {
    // fallback fetch met CORS
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: payload,
      mode: 'cors',
      credentials: 'omit'
    }).then(r => console.log('Fallback fetch sent', r.status))
      .catch(err => console.error('Fallback fetch failed', err));
  }
}

document.getElementById('btnAdd').addEventListener('click', addVisit);
</script>
</body>
</html>
